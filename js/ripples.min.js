function isPercentage(e){return"%"==e[e.length-1]}function loadConfig(){function e(e,t,i){var n="OES_texture_"+e,a=n+"_linear",o=a in r,l=[n];return o&&l.push(a),{type:t,arrayType:i,linearSupport:o,extensions:l}}var t=document.createElement("canvas");if(gl=t.getContext("webgl")||t.getContext("experimental-webgl"),!gl)return null;var r={};if(["OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear"].forEach(function(e){var t=gl.getExtension(e);t&&(r[e]=t)}),!r.OES_texture_float)return null;var i=[];i.push(e("float",gl.FLOAT,Float32Array)),r.OES_texture_half_float&&i.push(e("half_float",r.OES_texture_half_float.HALF_FLOAT_OES,null));var n=gl.createTexture(),a=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,a),gl.bindTexture(gl.TEXTURE_2D,n),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);for(var o=null,l=0;l<i.length;l++)if(gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,32,32,0,gl.RGBA,i[l].type,null),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,n,0),gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE){o=i[l];break}return o}function createImageData(e,t){try{return new ImageData(e,t)}catch(i){var r=document.createElement("canvas");return r.getContext("2d").createImageData(e,t)}}function translateBackgroundPosition(e){var t=e.split(" ");if(1!==t.length)return t.map(function(t){switch(e){case"center":return"50%";case"top":case"left":return"0";case"right":case"bottom":return"100%";default:return t}});switch(e){case"center":return["50%","50%"];case"top":return["50%","0"];case"bottom":return["50%","100%"];case"left":return["0","50%"];case"right":return["100%","50%"];default:return[e,"50%"]}}function createProgram(e,t,r){function i(e,t){var r=gl.createShader(e);if(gl.shaderSource(r,t),gl.compileShader(r),!gl.getShaderParameter(r,gl.COMPILE_STATUS))throw new Error("compile error: "+gl.getShaderInfoLog(r));return r}var n={};if(n.id=gl.createProgram(),gl.attachShader(n.id,i(gl.VERTEX_SHADER,e)),gl.attachShader(n.id,i(gl.FRAGMENT_SHADER,t)),gl.linkProgram(n.id),!gl.getProgramParameter(n.id,gl.LINK_STATUS))throw new Error("link error: "+gl.getProgramInfoLog(n.id));n.uniforms={},n.locations={},gl.useProgram(n.id),gl.enableVertexAttribArray(0);for(var a,o,l=/uniform (\w+) (\w+)/g,s=e+t;null!=(a=l.exec(s));)o=a[2],n.locations[o]=gl.getUniformLocation(n.id,o);return n}function bindTexture(e,t){gl.activeTexture(gl.TEXTURE0+(t||0)),gl.bindTexture(gl.TEXTURE_2D,e)}function extractUrl(e){var t=/url\(["']?([^"']*)["']?\)/.exec(e);return null==t?null:t[1]}function isDataUri(e){return e.match(/^data:/)}var gl,$window=document.window,config=loadConfig(),transparentPixels=createImageData(32,32);document.querySelector("head").prepend("<style>.jquery-ripples { position: relative; z-index: 0; }</style>");var Ripples=function(e,t){function r(){i.destroyed||(i.step(),requestAnimationFrame(r))}var i=this;console.log("test"),this.$elClean=e,this.interactive=t.interactive,this.resolution=t.resolution,this.textureDelta=new Float32Array([1/this.resolution,1/this.resolution]),this.perturbance=t.perturbance,this.dropRadius=t.dropRadius,this.crossOrigin=t.crossOrigin,this.imageUrl=t.imageUrl;var n=document.createElement("canvas");n.width=this.$elClean.getBoundingClientRect().width,n.height=this.$elClean.getBoundingClientRect().height,this.canvas=n,this.$canvas=n,this.canvas.style.position="absolute",this.canvas.style.left=0,this.canvas.style.top=0,this.canvas.style.right=0,this.canvas.style.bottom=0,this.canvas.style.zIndex=-1,this.$elClean.classList.add("jquery-ripples"),this.$elClean.append(n),this.context=gl=n.getContext("webgl")||n.getContext("experimental-webgl"),config.extensions.forEach(function(e){gl.getExtension(e)}),this.updateSize=this.updateSize.bind(this),window.addEventListener("resize",this.updateSize),this.textures=[],this.framebuffers=[],this.bufferWriteIndex=0,this.bufferReadIndex=1;for(var a=config.arrayType,o=a?new a(this.resolution*this.resolution*4):null,l=0;l<2;l++){var s=gl.createTexture(),g=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,g),gl.bindTexture(gl.TEXTURE_2D,s),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,config.linearSupport?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,config.linearSupport?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.resolution,this.resolution,0,gl.RGBA,config.type,o),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,s,0),this.textures.push(s),this.framebuffers.push(g)}this.quad=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.quad),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),gl.STATIC_DRAW),this.initShaders(),this.initTexture(),this.setTransparentTexture(),this.loadImage(),gl.clearColor(0,0,0,0),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),this.visible=!0,this.running=!0,this.inited=!0,this.destroyed=!1,this.setupPointerEvents(),requestAnimationFrame(r),console.log("test2")};Ripples.DEFAULTS={imageUrl:null,resolution:256,dropRadius:20,perturbance:.03,interactive:!0,crossOrigin:""},Ripples.prototype={setupPointerEvents:function(){function e(){return r.visible&&r.running&&r.interactive}function t(t,i){e()&&r.dropAtPointer(t,r.dropRadius*(i?1.5:1),i?.14:.01)}var r=this;this.$elClean.addEventListener("mousemove",function(e){t(e)}),this.$elClean.addEventListener("touchmove touchstart",function(e){for(var r=e.originalEvent.changedTouches,i=0;i<r.length;i++)t(r[i])}),this.$elClean.addEventListener("mousedown",function(e){t(e,!0)})},loadImage:function(){var e=this;gl=this.context;var t=this.imageUrl||extractUrl(this.originalCssBackgroundImage)||extractUrl(this.$elClean.style.backgroundImage);if(t!=this.imageSource)if(this.imageSource=t,this.imageSource){var r=new Image;r.onload=function(){function t(e){return 0==(e&e-1)}gl=e.context;var i=t(r.width)&&t(r.height)?gl.REPEAT:gl.CLAMP_TO_EDGE;gl.bindTexture(gl.TEXTURE_2D,e.backgroundTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,i),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,i),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,r),e.backgroundWidth=r.width,e.backgroundHeight=r.height,e.hideCssBackground()},r.onerror=function(){gl=e.context,e.setTransparentTexture()},r.crossOrigin=isDataUri(this.imageSource)?null:this.crossOrigin,r.src=this.imageSource}else this.setTransparentTexture()},step:function(){gl=this.context,this.visible&&(this.computeTextureBoundaries(),this.running&&this.update(),this.render())},drawQuad:function(){gl.bindBuffer(gl.ARRAY_BUFFER,this.quad),gl.vertexAttribPointer(0,2,gl.FLOAT,!1,0,0),gl.drawArrays(gl.TRIANGLE_FAN,0,4)},render:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,this.canvas.width,this.canvas.height),gl.enable(gl.BLEND),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.useProgram(this.renderProgram.id),bindTexture(this.backgroundTexture,0),bindTexture(this.textures[0],1),gl.uniform1f(this.renderProgram.locations.perturbance,this.perturbance),gl.uniform2fv(this.renderProgram.locations.topLeft,this.renderProgram.uniforms.topLeft),gl.uniform2fv(this.renderProgram.locations.bottomRight,this.renderProgram.uniforms.bottomRight),gl.uniform2fv(this.renderProgram.locations.containerRatio,this.renderProgram.uniforms.containerRatio),gl.uniform1i(this.renderProgram.locations.samplerBackground,0),gl.uniform1i(this.renderProgram.locations.samplerRipples,1),this.drawQuad(),gl.disable(gl.BLEND)},update:function(){gl.viewport(0,0,this.resolution,this.resolution),gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffers[this.bufferWriteIndex]),bindTexture(this.textures[this.bufferReadIndex]),gl.useProgram(this.updateProgram.id),this.drawQuad(),this.swapBufferIndices()},swapBufferIndices:function(){this.bufferWriteIndex=1-this.bufferWriteIndex,this.bufferReadIndex=1-this.bufferReadIndex},computeTextureBoundaries:function(){let e=this.$elClean.currentStyle||window.getComputedStyle(this.$elClean,!1);var t,r=e.backgroundSize,i=e.backgroundAttachment,n=translateBackgroundPosition(e.backgroundPosition);if("fixed"==i?(t={left:window.pageXOffset,top:window.pageYOffset},t.width=$window.width(),t.height=$window.height()):(t=this.$elClean.getBoundingClientRect(),t.width=this.$elClean.getBoundingClientRect().width,t.height=this.$elClean.getBoundingClientRect().height),"cover"==r)var a=Math.max(t.width/this.backgroundWidth,t.height/this.backgroundHeight),o=this.backgroundWidth*a,l=this.backgroundHeight*a;else if("contain"==r)a=Math.min(t.width/this.backgroundWidth,t.height/this.backgroundHeight),o=this.backgroundWidth*a,l=this.backgroundHeight*a;else{r=r.split(" ");o=r[0]||"",l=r[1]||o;isPercentage(o)?o=t.width*parseFloat(o)/100:"auto"!=o&&(o=parseFloat(o)),isPercentage(l)?l=t.height*parseFloat(l)/100:"auto"!=l&&(l=parseFloat(l)),"auto"==o&&"auto"==l?(o=this.backgroundWidth,l=this.backgroundHeight):("auto"==o&&(o=this.backgroundWidth*(l/this.backgroundHeight)),"auto"==l&&(l=this.backgroundHeight*(o/this.backgroundWidth)))}var s=n[0],g=n[1];s=isPercentage(s)?t.left+(t.width-o)*parseFloat(s)/100:t.left+parseFloat(s),g=isPercentage(g)?t.top+(t.height-l)*parseFloat(g)/100:t.top+parseFloat(g);var u=this.$elClean.getBoundingClientRect();this.renderProgram.uniforms.topLeft=new Float32Array([(u.left-s)/o,(u.top-g)/l]),this.renderProgram.uniforms.bottomRight=new Float32Array([this.renderProgram.uniforms.topLeft[0]+this.$elClean.getBoundingClientRect().width/o,this.renderProgram.uniforms.topLeft[1]+this.$elClean.getBoundingClientRect().height/l]);var h=Math.max(this.canvas.width,this.canvas.height);this.renderProgram.uniforms.containerRatio=new Float32Array([this.canvas.width/h,this.canvas.height/h])},initShaders:function(){var e=["attribute vec2 vertex;","varying vec2 coord;","void main() {","coord = vertex * 0.5 + 0.5;","gl_Position = vec4(vertex, 0.0, 1.0);","}"].join("\n");this.dropProgram=createProgram(e,["precision highp float;","const float PI = 3.141592653589793;","uniform sampler2D texture;","uniform vec2 center;","uniform float radius;","uniform float strength;","varying vec2 coord;","void main() {","vec4 info = texture2D(texture, coord);","float drop = max(0.0, 1.0 - length(center * 0.5 + 0.5 - coord) / radius);","drop = 0.5 - cos(drop * PI) * 0.5;","info.r += drop * strength;","gl_FragColor = info;","}"].join("\n")),this.updateProgram=createProgram(e,["precision highp float;","uniform sampler2D texture;","uniform vec2 delta;","varying vec2 coord;","void main() {","vec4 info = texture2D(texture, coord);","vec2 dx = vec2(delta.x, 0.0);","vec2 dy = vec2(0.0, delta.y);","float average = (","texture2D(texture, coord - dx).r +","texture2D(texture, coord - dy).r +","texture2D(texture, coord + dx).r +","texture2D(texture, coord + dy).r",") * 0.25;","info.g += (average - info.r) * 2.0;","info.g *= 0.995;","info.r += info.g;","gl_FragColor = info;","}"].join("\n")),gl.uniform2fv(this.updateProgram.locations.delta,this.textureDelta),this.renderProgram=createProgram(["precision highp float;","attribute vec2 vertex;","uniform vec2 topLeft;","uniform vec2 bottomRight;","uniform vec2 containerRatio;","varying vec2 ripplesCoord;","varying vec2 backgroundCoord;","void main() {","backgroundCoord = mix(topLeft, bottomRight, vertex * 0.5 + 0.5);","backgroundCoord.y = 1.0 - backgroundCoord.y;","ripplesCoord = vec2(vertex.x, -vertex.y) * containerRatio * 0.5 + 0.5;","gl_Position = vec4(vertex.x, -vertex.y, 0.0, 1.0);","}"].join("\n"),["precision highp float;","uniform sampler2D samplerBackground;","uniform sampler2D samplerRipples;","uniform vec2 delta;","uniform float perturbance;","varying vec2 ripplesCoord;","varying vec2 backgroundCoord;","void main() {","float height = texture2D(samplerRipples, ripplesCoord).r;","float heightX = texture2D(samplerRipples, vec2(ripplesCoord.x + delta.x, ripplesCoord.y)).r;","float heightY = texture2D(samplerRipples, vec2(ripplesCoord.x, ripplesCoord.y + delta.y)).r;","vec3 dx = vec3(delta.x, heightX - height, 0.0);","vec3 dy = vec3(0.0, heightY - height, delta.y);","vec2 offset = -normalize(cross(dy, dx)).xz;","float specular = pow(max(0.0, dot(offset, normalize(vec2(-0.6, 1.0)))), 4.0);","gl_FragColor = texture2D(samplerBackground, backgroundCoord + offset * perturbance) + specular;","}"].join("\n")),gl.uniform2fv(this.renderProgram.locations.delta,this.textureDelta)},initTexture:function(){this.backgroundTexture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.backgroundTexture),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,1),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR)},setTransparentTexture:function(){gl.bindTexture(gl.TEXTURE_2D,this.backgroundTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,transparentPixels)},hideCssBackground:function(){let e=this.$elClean.currentStyle||window.getComputedStyle(this.$elClean,!1);var t=e.backgroundImage;"none"!=t&&(this.originalInlineCss=t,this.originalCssBackgroundImage=e.backgroundImage,this.$elClean.style.backgroundImage="none")},restoreCssBackground:function(){this.$elClean.style.backgroundImage=this.originalInlineCss||""},dropAtPointer:function(e,t,r){let i=this.$elClean.currentStyle||window.getComputedStyle(this.$elClean,!1);var n=parseInt(i.borderLeftWidth)||0,a=parseInt(i.borderTopWidth)||0;this.drop(e.pageX-this.$elClean.getBoundingClientRect().left-n,e.pageY-this.$elClean.getBoundingClientRect().top-a,t,r)},drop:function(e,t,r,i){gl=this.context;var n=this.$elClean.getBoundingClientRect().width,a=this.$elClean.getBoundingClientRect().height,o=Math.max(n,a);r/=o;var l=new Float32Array([(2*e-n)/o,(a-2*t)/o]);gl.viewport(0,0,this.resolution,this.resolution),gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffers[this.bufferWriteIndex]),bindTexture(this.textures[this.bufferReadIndex]),gl.useProgram(this.dropProgram.id),gl.uniform2fv(this.dropProgram.locations.center,l),gl.uniform1f(this.dropProgram.locations.radius,r),gl.uniform1f(this.dropProgram.locations.strength,i),this.drawQuad(),this.swapBufferIndices()},updateSize:function(){var e=this.$elClean.getBoundingClientRect().width,t=this.$elClean.getBoundingClientRect().height;e==this.canvas.width&&t==this.canvas.height||(this.canvas.width=e,this.canvas.height=t)},destroy:function(){this.$el.off(".ripples").removeClass("jquery-ripples").removeData("ripples"),gl=null,$(window).off("resize",this.updateSize),this.$canvas.remove(),this.restoreCssBackground(),this.destroyed=!0},show:function(){this.visible=!0,this.$canvas.show(),this.hideCssBackground()},hide:function(){this.visible=!1,this.$canvas.hide(),this.restoreCssBackground()},pause:function(){this.running=!1},play:function(){this.running=!0},set:function(e,t){switch(e){case"dropRadius":case"perturbance":case"interactive":case"crossOrigin":this[e]=t;break;case"imageUrl":this.imageUrl=t,this.loadImage()}}};